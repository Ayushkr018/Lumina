<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lumina AI - Live Eye Monitoring Dashboard</title>
    <meta name="description" content="Real-time eye strain monitoring with AI-powered computer vision and advanced health analytics">
    
    <!-- Preload critical resources -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" as="style">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- PWA MANIFEST AND META TAGS -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#6366f1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Lumina AI">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
    <meta name="msapplication-TileColor" content="#6366f1">
    <meta name="msapplication-config" content="/browserconfig.xml">
    
    <!-- PWA SERVICE WORKER REGISTRATION -->
    <script>
        // Register Service Worker for PWA functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(function(registration) {
                        console.log('✅ PWA ServiceWorker registered:', registration.scope);
                        
                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // Show update notification using existing alert system
                                    if (typeof showAlert === 'function') {
                                        showAlert('📱 New version available! Refresh to update.', 'success');
                                    }
                                }
                            });
                        });
                    })
                    .catch(function(error) {
                        console.warn('❌ PWA ServiceWorker registration failed:', error);
                    });
            });
        }

        // PWA Install Prompt Handler
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show PWA install notification
            setTimeout(() => {
                if (typeof showAlert === 'function') {
                    showAlert('📱 Lumina AI can be installed! Look for the install option in your browser.', 'success');
                }
            }, 3000);
        });
        
        // PWA Installation Success
        window.addEventListener('appinstalled', () => {
            console.log('🎉 PWA installed successfully!');
            if (typeof showAlert === 'function') {
                showAlert('🎉 Lumina AI installed! Access from your home screen.', 'success');
            }
            deferredPrompt = null;
        });

        // Handle PWA display mode
        function checkPWAMode() {
            const isPWA = window.matchMedia('(display-mode: standalone)').matches || 
                          window.navigator.standalone === true;
            
            if (isPWA) {
                console.log('📱 Running as PWA!');
                document.body.classList.add('pwa-mode');
            }
        }
        
        // Check PWA mode when DOM is ready
        document.addEventListener('DOMContentLoaded', checkPWAMode);
    </script>
    
    <!-- Favicons -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='35' fill='%236366f1'/><circle cx='50' cy='50' r='20' fill='white'/><circle cx='50' cy='50' r='8' fill='%236366f1'/></svg>">

    <style>
        :root {
            /* Modern Color Palette */
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #8b5cf6;
            --secondary: #06b6d4;
            --accent: #f59e0b;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-accent: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --gradient-success: linear-gradient(135deg, #10b981 0%, #059669 100%);
            
            /* Light Theme */
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --bg-glass: rgba(255, 255, 255, 0.85);
            --bg-glass-strong: rgba(255, 255, 255, 0.95);
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --text-inverse: #ffffff;
            --border: #e2e8f0;
            --border-light: rgba(255, 255, 255, 0.2);
            --shadow: rgba(15, 23, 42, 0.1);
            --shadow-strong: rgba(15, 23, 42, 0.2);
            --backdrop: rgba(0, 0, 0, 0.6);
            
            /* Typography */
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --transition-base: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-bounce: 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --bg-glass: rgba(30, 41, 59, 0.85);
            --bg-glass-strong: rgba(30, 41, 59, 0.95);
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --text-inverse: #0f172a;
            --border: #475569;
            --border-light: rgba(148, 163, 184, 0.2);
            --shadow: rgba(0, 0, 0, 0.5);
            --shadow-strong: rgba(0, 0, 0, 0.7);
            --backdrop: rgba(0, 0, 0, 0.8);
        }

        /* PWA-specific styles */
        .pwa-mode .header {
            padding-top: env(safe-area-inset-top);
        }
        
        .pwa-mode .floating-controls {
            bottom: calc(20px + env(safe-area-inset-bottom));
        }

        /* Global Styles */
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.6;
            transition: all var(--transition-base);
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
            -webkit-user-select: none;
            -moz-user-select: none;
            user-select: none;
        }

        input, textarea, button {
            -webkit-user-select: text;
            -moz-user-select: text;
            user-select: text;
        }

        /* Scroll Progress Bar */
        .scroll-progress {
            position: fixed;
            top: 0;
            left: 0;
            width: 0%;
            height: 3px;
            background: var(--gradient-primary);
            z-index: 10001;
            transition: width 0.1s ease;
            box-shadow: 0 0 10px var(--primary);
        }

        /* Background Effects */
        .bg-effects {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            overflow: hidden;
        }

        .gradient-orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(100px);
            opacity: 0.4;
            animation: orbFloat 25s ease-in-out infinite;
        }

        .orb-1 {
            width: 400px;
            height: 400px;
            background: var(--gradient-primary);
            top: -200px;
            right: -200px;
            animation-delay: 0s;
        }

        .orb-2 {
            width: 300px;
            height: 300px;
            background: var(--gradient-secondary);
            bottom: -150px;
            left: -150px;
            animation-delay: -12s;
        }

        .orb-3 {
            width: 250px;
            height: 250px;
            background: var(--gradient-accent);
            top: 40%;
            left: 60%;
            animation-delay: -8s;
        }

        @keyframes orbFloat {
            0%, 100% { transform: translate(0, 0) scale(1) rotate(0deg); }
            25% { transform: translate(30px, -30px) scale(1.1) rotate(90deg); }
            50% { transform: translate(-20px, 20px) scale(0.9) rotate(180deg); }
            75% { transform: translate(20px, 30px) scale(1.05) rotate(270deg); }
        }

        .container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* FIXED Revolutionary Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--bg-glass);
            backdrop-filter: blur(30px);
            border-bottom: 1px solid var(--border-light);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 1000;
            box-shadow: 0 8px 32px rgba(99, 102, 241, 0.3);
            transition: all var(--transition-base);
        }

        .header.scrolled {
            background: var(--bg-glass-strong);
            box-shadow: 0 12px 40px var(--shadow-strong);
            border-bottom-color: var(--border);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 2rem;
            flex: 1;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            transition: all var(--transition-bounce);
            position: relative;
            padding: 0.5rem;
            border-radius: 25px;
        }

        .logo-section:hover {
            transform: scale(1.05);
            background: rgba(99, 102, 241, 0.1);
        }

        /* Clean Eye Logo WITHOUT LASHES */
        .dashboard-logo {
            position: relative;
            width: 50px;
            height: 35px;
        }

        .logo-eye {
            width: 50px;
            height: 35px;
            background: var(--gradient-primary);
            border-radius: 50%;
            position: relative;
            overflow: hidden;
            box-shadow: 0 6px 25px rgba(99, 102, 241, 0.4);
            animation: logoFloat 4s ease-in-out infinite;
            border: 2px solid var(--border-light);
        }

        .logo-eye::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 25px;
            height: 25px;
            background: var(--text-inverse);
            border-radius: 50%;
            border: 1px solid rgba(255,255,255,0.3);
            animation: eyeballFloat 3s ease-in-out infinite;
        }

        .logo-pupil {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 10px;
            background: var(--primary-dark);
            border-radius: 50%;
            animation: pupilTrack 5s ease-in-out infinite;
            box-shadow: 0 0 8px rgba(79, 70, 229, 0.8);
        }

        @keyframes logoFloat {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-2px) rotate(2deg); }
        }

        @keyframes eyeballFloat {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.05); }
        }

        @keyframes pupilTrack {
            0%, 100% { transform: translate(-50%, -50%) translateX(0); }
            25% { transform: translate(-50%, -50%) translateX(4px); }
            75% { transform: translate(-50%, -50%) translateX(-4px); }
        }

        .logo-text {
            font-weight: 900;
            font-size: 1.5rem;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            position: relative;
        }

        .nav-menu {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            padding: 0.5rem;
            border: 1px solid var(--border-light);
        }

        .nav-item {
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            transition: all var(--transition-base);
            position: relative;
            overflow: hidden;
            font-size: 0.9rem;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: var(--gradient-primary);
            transition: left 0.3s ease;
            z-index: -1;
        }

        .nav-item:hover::before,
        .nav-item.active::before {
            left: 0;
        }

        .nav-item:hover,
        .nav-item.active {
            color: var(--text-inverse);
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--text-secondary);
            font-weight: 600;
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            border: 1px solid var(--border-light);
            font-size: 0.9rem;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-inverse);
            font-weight: 700;
            font-size: 0.9rem;
            animation: avatarGlow 3s ease-in-out infinite;
        }

        @keyframes avatarGlow {
            0%, 100% { box-shadow: 0 0 15px rgba(99, 102, 241, 0.3); }
            50% { box-shadow: 0 0 25px rgba(99, 102, 241, 0.5); }
        }

        .theme-toggle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--border-light);
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-bounce);
            position: relative;
            overflow: hidden;
        }

        .theme-toggle::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: var(--gradient-primary);
            transition: left 0.3s ease;
            opacity: 0.2;
        }

        .theme-toggle:hover::before {
            left: 0;
        }

        .theme-toggle:hover {
            transform: scale(1.1) rotate(180deg);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.3);
            border-color: var(--primary);
        }

        .theme-toggle svg {
            width: 18px;
            height: 18px;
            stroke: var(--text-secondary);
            transition: all var(--transition-base);
        }

        /* Mobile Menu Button */
        .mobile-menu-btn {
            display: none;
            flex-direction: column;
            gap: 3px;
            background: var(--bg-glass);
            backdrop-filter: blur(10px);
            border: 2px solid var(--border-light);
            border-radius: 8px;
            padding: 0.5rem;
            transition: all var(--transition-base);
            cursor: pointer;
        }

        .mobile-menu-btn span {
            width: 20px;
            height: 2px;
            background: var(--text-primary);
            transition: all var(--transition-base);
            border-radius: 1px;
        }

        .mobile-menu-btn.active span:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }

        .mobile-menu-btn.active span:nth-child(2) {
            opacity: 0;
        }

        .mobile-menu-btn.active span:nth-child(3) {
            transform: rotate(-45deg) translate(5px, -5px);
        }

        /* Mobile Menu */
        .mobile-menu {
            position: fixed;
            top: 70px;
            left: 1rem;
            right: 1rem;
            background: var(--bg-glass-strong);
            backdrop-filter: blur(30px);
            border: 1px solid var(--border-light);
            border-radius: 20px;
            transform: translateY(-20px);
            transition: all var(--transition-base);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            box-shadow: 0 8px 40px var(--shadow-strong);
        }

        .mobile-menu.active {
            transform: translateY(0);
            opacity: 1;
            visibility: visible;
        }

        .mobile-nav-links {
            display: flex;
            flex-direction: column;
            padding: 2rem;
            gap: 1rem;
        }

        .mobile-nav-links .nav-item {
            padding: 1rem;
            border-radius: 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
        }

        /* Main Content with proper spacing for fixed header */
        .main-content {
            flex: 1;
            padding: 6rem 2rem 3rem;
            max-width: 1600px;
            margin: 0 auto;
            width: 100%;
        }

        /* Monitor Status Bar */
        .monitor-status {
            background: var(--bg-glass);
            backdrop-filter: blur(30px);
            border: 1px solid var(--border-light);
            border-radius: 20px;
            padding: 1.5rem 2rem;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 8px 32px var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .monitor-status::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-success);
        }

        .status-left {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }

        .status-dot.active {
            background: var(--success);
            box-shadow: 0 0 10px var(--success);
        }

        .status-dot.inactive {
            background: var(--error);
            box-shadow: 0 0 10px var(--error);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.2); }
        }

        .session-time {
            font-weight: 600;
            color: var(--text-secondary);
        }

        .status-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .control-btn {
            padding: 0.5rem 1rem;
            border: 2px solid var(--primary);
            border-radius: 12px;
            background: transparent;
            color: var(--primary);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-base);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .control-btn:hover {
            background: var(--primary);
            color: var(--text-inverse);
            transform: translateY(-2px);
        }

        .control-btn.stop {
            border-color: var(--error);
            color: var(--error);
        }

        .control-btn.stop:hover {
            background: var(--error);
            color: var(--text-inverse);
        }

        /* Camera Section */
        .camera-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .camera-container {
            background: var(--bg-glass);
            backdrop-filter: blur(30px);
            border: 1px solid var(--border-light);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 40px var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .camera-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
        }

        .camera-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }

        .camera-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .camera-icon {
            width: 24px;
            height: 24px;
            stroke: var(--primary);
            fill: none;
            stroke-width: 2;
        }

        .video-container {
            position: relative;
            background: #000;
            border-radius: 16px;
            overflow: hidden;
            aspect-ratio: 16/9;
            border: 2px solid var(--border);
        }

        .video-feed {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 1rem;
            color: var(--text-muted);
            background: var(--bg-tertiary);
        }

        .video-overlay {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            backdrop-filter: blur(10px);
        }

        /* Audio Level Indicator */
        .audio-level {
            position: absolute;
            bottom: 1rem;
            left: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            backdrop-filter: blur(10px);
        }

        .audio-bars {
            display: flex;
            align-items: end;
            gap: 2px;
            height: 20px;
        }

        .audio-bar {
            width: 3px;
            background: var(--success);
            border-radius: 2px;
            transition: height 0.1s ease;
        }

        .audio-bar:nth-child(1) { height: 4px; }
        .audio-bar:nth-child(2) { height: 8px; }
        .audio-bar:nth-child(3) { height: 12px; }
        .audio-bar:nth-child(4) { height: 16px; }
        .audio-bar:nth-child(5) { height: 20px; }

        .audio-bar.active {
            background: var(--primary);
            animation: audioBarPulse 0.5s ease-in-out;
        }

        @keyframes audioBarPulse {
            0%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(1.3); }
        }

        /* FLOATING BOTTOM CONTROLS - NEW */
        .floating-controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(30px);
            border: 1px solid var(--border-light);
            border-radius: 30px;
            padding: 15px 25px;
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 99999;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            transition: all var(--transition-base);
        }

        .floating-controls:hover {
            transform: translateX(-50%) translateY(-5px);
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.7);
        }

        .floating-btn {
            background: transparent;
            border: 2px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-base);
            color: var(--primary);
            position: relative;
            overflow: hidden;
        }

        .floating-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: var(--primary);
            transition: left 0.3s ease;
            z-index: -1;
        }

        .floating-btn:hover::before {
            left: 0;
        }

        .floating-btn:hover {
            color: white;
            transform: scale(1.1);
            box-shadow: 0 5px 20px rgba(99, 102, 241, 0.4);
        }

        .floating-btn:disabled {
            background: #333;
            border-color: #555;
            color: #666;
            cursor: not-allowed;
            transform: none;
        }

        .floating-btn:disabled::before {
            display: none;
        }

        .floating-btn svg {
            width: 20px;
            height: 20px;
            transition: all var(--transition-base);
        }

        .floating-btn.active {
            background: var(--primary);
            color: white;
        }

        .floating-btn.camera-off {
            border-color: var(--warning);
            color: var(--warning);
        }

        .floating-btn.camera-off::before {
            background: var(--warning);
        }

        .floating-btn.mic-off {
            border-color: var(--error);
            color: var(--error);
        }

        .floating-btn.mic-off::before {
            background: var(--error);
        }

        .floating-btn.start-btn {
            border-color: var(--success);
            color: var(--success);
            width: 60px;
            height: 60px;
        }

        .floating-btn.start-btn::before {
            background: var(--success);
        }

        .floating-btn.stop-btn {
            border-color: var(--error);
            color: var(--error);
            width: 60px;
            height: 60px;
        }

        .floating-btn.stop-btn::before {
            background: var(--error);
        }

        /* Analysis Panel */
        .analysis-panel {
            background: var(--bg-glass);
            backdrop-filter: blur(30px);
            border: 1px solid var(--border-light);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 40px var(--shadow);
        }

        .analysis-header {
            margin-bottom: 2rem;
        }

        .analysis-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .analysis-subtitle {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .detection-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .detection-item {
            padding: 1.5rem;
            background: var(--bg-primary);
            border-radius: 16px;
            border: 1px solid var(--border);
            transition: all var(--transition-base);
            position: relative;
            overflow: hidden;
        }

        .detection-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--gradient-primary);
        }

        .detection-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px var(--shadow);
        }

        .detection-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .detection-value {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .detection-status {
            font-size: 0.85rem;
            font-weight: 600;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            display: inline-block;
        }

        .status-good {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .status-warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .status-critical {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
        }

        /* Live Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .metric-card {
            background: var(--bg-glass);
            backdrop-filter: blur(30px);
            border: 1px solid var(--border-light);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 40px var(--shadow);
            transition: all var(--transition-base);
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: conic-gradient(from 0deg, var(--primary), var(--secondary), var(--primary));
            opacity: 0.1;
            animation: rotateGradient 10s linear infinite;
            border-radius: 50%;
        }

        .metric-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 60px var(--shadow-strong);
        }

        @keyframes rotateGradient {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .metric-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }

        .metric-icon {
            width: 50px;
            height: 50px;
            background: var(--gradient-primary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }

        .metric-icon svg {
            width: 24px;
            height: 24px;
            stroke: var(--text-inverse);
            fill: none;
            stroke-width: 2;
        }

        .metric-label {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 900;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            font-variant-numeric: tabular-nums;
        }

        .metric-unit {
            font-size: 0.9rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        .metric-trend {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .trend-up {
            color: var(--success);
        }

        .trend-down {
            color: var(--error);
        }

        .trend-stable {
            color: var(--text-secondary);
        }

        /* Health Recommendations */
        .recommendations {
            background: var(--bg-glass);
            backdrop-filter: blur(30px);
            border: 1px solid var(--border-light);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 40px var(--shadow);
            margin-bottom: 3rem;
        }

        .recommendations-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .recommendations-icon {
            width: 50px;
            height: 50px;
            background: var(--gradient-success);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .recommendations-icon svg {
            width: 24px;
            height: 24px;
            stroke: var(--text-inverse);
            fill: none;
            stroke-width: 2;
        }

        .recommendations-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .recommendation-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .recommendation-item {
            padding: 1.5rem;
            background: var(--bg-primary);
            border-radius: 16px;
            border: 1px solid var(--border);
            display: flex;
            align-items: start;
            gap: 1rem;
            transition: all var(--transition-base);
        }

        .recommendation-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 20px var(--shadow);
        }

        .recommendation-icon {
            width: 40px;
            height: 40px;
            background: var(--gradient-accent);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .recommendation-icon svg {
            width: 20px;
            height: 20px;
            stroke: var(--text-inverse);
            fill: none;
            stroke-width: 2;
        }

        .recommendation-content {
            flex: 1;
        }

        .recommendation-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .recommendation-desc {
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* Alert System */
        .alert-container {
            position: fixed;
            top: 6rem;
            right: 2rem;
            z-index: 1001;
            max-width: 400px;
        }

        .alert {
            background: var(--bg-glass-strong);
            backdrop-filter: blur(30px);
            border: 1px solid var(--border-light);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 8px 32px var(--shadow-strong);
            transform: translateX(100%);
            transition: all var(--transition-bounce);
            position: relative;
            overflow: hidden;
        }

        .alert.show {
            transform: translateX(0);
        }

        .alert::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
        }

        .alert.warning::before {
            background: var(--warning);
        }

        .alert.error::before {
            background: var(--error);
        }

        .alert.success::before {
            background: var(--success);
        }

        .alert-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .alert-title {
            font-weight: 700;
            font-size: 1rem;
        }

        .alert-close {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--text-muted);
            padding: 0;
        }

        .alert-message {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* RESPONSIVE DESIGN */
        @media (max-width: 1200px) {
            .camera-section {
                grid-template-columns: 1fr;
            }

            .detection-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .nav-menu {
                display: none;
            }

            .mobile-menu-btn {
                display: flex;
            }

            .header {
                padding: 1rem;
            }

            .main-content {
                padding: 5rem 1rem 2rem;
            }

            .monitor-status {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }

            .status-right {
                width: 100%;
                justify-content: space-between;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .metric-value {
                font-size: 2rem;
            }

            .alert-container {
                right: 1rem;
                left: 1rem;
                max-width: none;
            }

            .camera-container {
                padding: 1.5rem;
            }

            .analysis-panel {
                padding: 1.5rem;
            }

            .recommendations {
                padding: 1.5rem;
            }

            .floating-controls {
                bottom: 10px;
                left: 10px;
                right: 10px;
                transform: none;
                justify-content: center;
                flex-wrap: wrap;
                gap: 10px;
                padding: 12px 15px;
            }

            .floating-controls:hover {
                transform: none;
            }

            .floating-btn {
                width: 45px;
                height: 45px;
            }

            .floating-btn.start-btn,
            .floating-btn.stop-btn {
                width: 55px;
                height: 55px;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 0.75rem;
            }

            .main-content {
                padding: 4.5rem 0.75rem 1.5rem;
            }

            .logo-text {
                font-size: 1.2rem;
            }

            .user-info span {
                display: none;
            }

            .monitor-status {
                padding: 1rem;
            }

            .metric-card {
                padding: 1.5rem;
            }

            .metric-value {
                font-size: 1.8rem;
            }

            .camera-container,
            .analysis-panel,
            .recommendations {
                padding: 1rem;
            }

            .floating-controls {
                padding: 10px;
                gap: 8px;
            }

            .floating-btn {
                width: 40px;
                height: 40px;
            }

            .floating-btn.start-btn,
            .floating-btn.stop-btn {
                width: 50px;
                height: 50px;
            }

            .floating-btn svg {
                width: 16px;
                height: 16px;
            }
        }

        /* Utility Classes */
        .fade-in {
            opacity: 0;
            transform: translateY(30px);
            transition: all var(--transition-base);
        }

        .fade-in.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* Print Styles */
        @media print {
            .header, .mobile-menu, .bg-effects, .scroll-progress, .alert-container, .floating-controls {
                display: none !important;
            }
            
            .main-content {
                padding: 0 !important;
            }
        }
    </style>
</head>
<body>
    <!-- Scroll Progress Bar -->
    <div class="scroll-progress" id="scrollProgress"></div>

    <!-- Background Effects -->
    <div class="bg-effects">
        <div class="gradient-orb orb-1"></div>
        <div class="gradient-orb orb-2"></div>
        <div class="gradient-orb orb-3"></div>
    </div>

    <!-- Alert Container -->
    <div class="alert-container" id="alertContainer"></div>

    <!-- FLOATING BOTTOM CONTROLS - NEW -->
    <div class="floating-controls" id="floatingControls">
        <button class="floating-btn start-btn" id="floatingStartBtn" title="Start Monitoring">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="5 3 19 12 5 21 5 3"/>
            </svg>
        </button>
        <button class="floating-btn stop-btn" id="floatingStopBtn" style="display: none;" title="Stop Monitoring">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="6" y="4" width="4" height="16"/>
                <rect x="14" y="4" width="4" height="16"/>
            </svg>
        </button>
        <button class="floating-btn" id="floatingCameraBtn" disabled title="Toggle Camera">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                <circle cx="12" cy="13" r="4"/>
            </svg>
        </button>
        <button class="floating-btn" id="floatingMicBtn" disabled title="Toggle Microphone">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/>
                <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                <line x1="12" y1="19" x2="12" y2="23"/>
                <line x1="8" y1="23" x2="16" y2="23"/>
            </svg>
        </button>
    </div>

    <div class="container">
        <!-- Header -->
        <header class="header" id="header">
            <div class="header-left">
                <div class="logo-section" onclick="window.location.href='index.html'" title="Return to Landing Page">
                    <div class="dashboard-logo">
                        <div class="logo-eye">
                            <div class="logo-pupil"></div>
                        </div>
                    </div>
                    <div class="logo-text">Lumina AI</div>
                </div>
                
                <nav class="nav-menu">
                    <a href="dashboard.html" class="nav-item">Dashboard</a>
                    <a href="monitor.html" class="nav-item active">Monitor</a>
                    <a href="analytics.html" class="nav-item">Analytics</a>
                    <a href="exercises.html" class="nav-item">Exercises</a>
                    <a href="profile.html" class="nav-item">Profile</a>
                    <a href="settings.html" class="nav-item">Settings</a>
                </nav>
            </div>
            
            <div class="header-right">
                <div class="user-info">
                    <div class="user-avatar">U</div>
                    <span>Dr. User</span>
                </div>
                <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                </button>
                <button class="mobile-menu-btn" id="mobileMenuBtn">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </header>

        <!-- Mobile Menu -->
        <div class="mobile-menu" id="mobileMenu">
            <div class="mobile-nav-links">
                <a href="dashboard.html" class="nav-item">Dashboard</a>
                <a href="monitor.html" class="nav-item active">Monitor</a>
                <a href="analytics.html" class="nav-item">Analytics</a>
                 <a href="exercises.html" class="nav-item">Exercises</a>
                <a href="profile.html" class="nav-item">Profile</a>
                <a href="settings.html" class="nav-item">Settings</a>
            </div>
        </div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Monitor Status -->
            <div class="monitor-status">
                <div class="status-left">
                    <div class="status-indicator">
                        <div class="status-dot inactive" id="statusDot"></div>
                        <span id="statusText">Ready to Start Monitoring</span>
                    </div>
                    <div class="session-time">
                        Session: <span id="sessionTimer">00:00:00</span>
                    </div>
                </div>
                <div class="status-right">
                    <button class="control-btn" id="startBtn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="5 3 19 12 5 21 5 3"/>
                        </svg>
                        Start Monitor
                    </button>
                    <button class="control-btn stop" id="stopBtn" style="display: none;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="6" y="4" width="4" height="16"/>
                            <rect x="14" y="4" width="4" height="16"/>
                        </svg>
                        Stop Monitor
                    </button>
                </div>
            </div>

            <!-- Camera and Analysis Section -->
            <div class="camera-section">
                <div class="camera-container">
                    <div class="camera-header">
                        <div class="camera-title">
                            <svg class="camera-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                                <circle cx="12" cy="13" r="4"/>
                            </svg>
                            Live Camera & Audio Feed
                        </div>
                    </div>
                    <div class="video-container">
                        <video id="videoFeed" class="video-feed" autoplay playsinline muted style="display: none;"></video>
                        <div class="video-placeholder" id="videoPlaceholder">
                            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                                <circle cx="12" cy="13" r="4"/>
                            </svg>
                            <p>Click "Start Monitor" to begin camera & microphone feed</p>
                        </div>
                        <div class="video-overlay" style="display: none;">
                            🟢 LIVE
                        </div>
                        <div class="audio-level" style="display: none;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/>
                                <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                                <line x1="12" y1="19" x2="12" y2="23"/>
                                <line x1="8" y1="23" x2="16" y2="23"/>
                            </svg>
                            <div class="audio-bars">
                                <div class="audio-bar"></div>
                                <div class="audio-bar"></div>
                                <div class="audio-bar"></div>
                                <div class="audio-bar"></div>
                                <div class="audio-bar"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="analysis-panel">
                    <div class="analysis-header">
                        <h3 class="analysis-title">AI Multi-Modal Analysis</h3>
                        <p class="analysis-subtitle">Computer vision + audio processing with real-time health monitoring</p>
                    </div>
                    
                    <div class="detection-grid">
                        <div class="detection-item">
                            <div class="detection-label">Left Eye Status</div>
                            <div class="detection-value" id="leftEyeStatus">--</div>
                            <span class="detection-status status-good" id="leftEyeStatusLabel">Detecting...</span>
                        </div>
                        <div class="detection-item">
                            <div class="detection-label">Right Eye Status</div>
                            <div class="detection-value" id="rightEyeStatus">--</div>
                            <span class="detection-status status-good" id="rightEyeStatusLabel">Detecting...</span>
                        </div>
                        <div class="detection-item">
                            <div class="detection-label">Blink Rate</div>
                            <div class="detection-value" id="blinkCount">0</div>
                            <span class="detection-status status-good">per minute</span>
                        </div>
                        <div class="detection-item">
                            <div class="detection-label">Audio Level</div>
                            <div class="detection-value" id="audioLevel">0</div>
                            <span class="detection-status status-good">dB</span>
                        </div>
                    </div>

                    <div style="margin-top: 1.5rem; padding: 1rem; background: var(--bg-secondary); border-radius: 12px;">
                        <h4 style="margin-bottom: 0.5rem; color: var(--text-primary);">AI Processing Status</h4>
                        <p style="color: var(--text-secondary); font-size: 0.9rem;">
                            <span id="processingStatus">Camera & microphone access required for analysis</span>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Live Metrics -->
            <div class="metrics-grid">
                <div class="metric-card fade-in">
                    <div class="metric-header">
                        <div class="metric-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="3"/>
                                <path d="M12 1v6M12 17v6M4.22 4.22l4.24 4.24M15.54 15.54l4.24 4.24M1 12h6M17 12h6M4.22 19.78l4.24-4.24M15.54 8.46l4.24-4.24"/>
                            </svg>
                        </div>
                    </div>
                    <div class="metric-label">Blink Rate</div>
                    <div class="metric-value" id="blinkRateValue">18</div>
                    <div class="metric-unit">blinks/min</div>
                    <div class="metric-trend trend-stable">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="23,12 17,6 11,12 5,6 1,12"/>
                        </svg>
                        Stable
                    </div>
                </div>

                <div class="metric-card fade-in">
                    <div class="metric-header">
                        <div class="metric-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/>
                                <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                            </svg>
                        </div>
                    </div>
                    <div class="metric-label">Voice Stress</div>
                    <div class="metric-value" id="voiceStressValue">12</div>
                    <div class="metric-unit">% detected</div>
                    <div class="metric-trend trend-down">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="23,18 13.5,8.5 8.5,13.5 1,6"/>
                        </svg>
                        Low
                    </div>
                </div>

                <div class="metric-card fade-in">
                    <div class="metric-header">
                        <div class="metric-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <polyline points="12,6 12,12 16,14"/>
                            </svg>
                        </div>
                    </div>
                    <div class="metric-label">Session Time</div>
                    <div class="metric-value" id="sessionTimeValue">0</div>
                    <div class="metric-unit">minutes</div>
                    <div class="metric-trend trend-up">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="23,6 13.5,15.5 8.5,10.5 1,18"/>
                        </svg>
                        Active
                    </div>
                </div>

                <div class="metric-card fade-in">
                    <div class="metric-header">
                        <div class="metric-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                            </svg>
                        </div>
                    </div>
                    <div class="metric-label">Health Score</div>
                    <div class="metric-value" id="healthScoreValue">94</div>
                    <div class="metric-unit">/ 100</div>
                    <div class="metric-trend trend-up">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="23,6 13.5,15.5 8.5,10.5 1,18"/>
                        </svg>
                        Excellent
                    </div>
                </div>
            </div>

            <!-- Health Recommendations -->
            <div class="recommendations fade-in">
                <div class="recommendations-header">
                    <div class="recommendations-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 11H5a2 2 0 0 0-2 2v3c0 1.1.9 2 2 2h4m6-6h4a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2h-4m-6 0a2 2 0 0 0-2-2v-3a2 2 0 0 0 2-2m6 0a2 2 0 0 1 2-2v3a2 2 0 0 1-2 2m-3-3h.01"/>
                        </svg>
                    </div>
                    <div>
                        <h3 class="recommendations-title">AI Health Recommendations</h3>
                    </div>
                </div>

                <div class="recommendation-list" id="recommendationList">
                    <div class="recommendation-item">
                        <div class="recommendation-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <polyline points="12,6 12,12 16,14"/>
                            </svg>
                        </div>
                        <div class="recommendation-content">
                            <h4 class="recommendation-title">Multi-Modal Monitoring Active</h4>
                            <p class="recommendation-desc">Advanced AI is analyzing both visual and audio patterns to provide comprehensive health insights and early fatigue detection.</p>
                        </div>
                    </div>

                    <div class="recommendation-item">
                        <div class="recommendation-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/>
                                <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                            </svg>
                        </div>
                        <div class="recommendation-content">
                            <h4 class="recommendation-title">Voice Stress Analysis</h4>
                            <p class="recommendation-desc">Your voice patterns indicate low stress levels. The AI monitors vocal frequency changes that correlate with mental fatigue and eye strain.</p>
                        </div>
                    </div>

                    <div class="recommendation-item">
                        <div class="recommendation-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 9V5a3 3 0 0 0-6 0v4"/>
                                <rect x="2" y="9" width="20" height="12" rx="2" ry="2"/>
                            </svg>
                        </div>
                        <div class="recommendation-content">
                            <h4 class="recommendation-title">Privacy Protection Active</h4>
                            <p class="recommendation-desc">All audio and video processing happens locally on your device. No data is transmitted or stored externally, ensuring complete privacy.</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Global Variables
        let currentTheme = localStorage.getItem('theme') || 'light';
        let isMonitoring = false;
        let videoStream = null;
        let audioContext = null;
        let audioAnalyser = null;
        let audioSource = null;
        let videoTrack = null;
        let audioTrack = null;
        let sessionStartTime = null;
        let sessionTimer = null;
        let blinkCount = 0;
        let lastBlinkTime = 0;
        let blinkRate = 0;
        let eyeAspectRatio = 0.3;
        let voiceStress = 12;
        let healthScore = 94;
        let audioLevel = 0;
        let isCameraOn = true;
        let isMicOn = true;

        // DOM Elements
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const sessionTimerEl = document.getElementById('sessionTimer');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const videoFeed = document.getElementById('videoFeed');
        const videoPlaceholder = document.getElementById('videoPlaceholder');
        const processingStatus = document.getElementById('processingStatus');

        // Floating Controls
        const floatingStartBtn = document.getElementById('floatingStartBtn');
        const floatingStopBtn = document.getElementById('floatingStopBtn');
        const floatingCameraBtn = document.getElementById('floatingCameraBtn');
        const floatingMicBtn = document.getElementById('floatingMicBtn');

        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            setTheme(currentTheme);
            setupScrollEffects();
            setupMobileMenu();
            setupAnimations();
            setupEventListeners();
            startMetricUpdates();
            console.log('🎥🎤 Lumina AI Monitor with PWA support initialized successfully!');
        }

        function setupEventListeners() {
            // Main buttons
            startBtn.addEventListener('click', startMonitoring);
            stopBtn.addEventListener('click', stopMonitoring);
            
            // Floating buttons
            floatingStartBtn.addEventListener('click', startMonitoring);
            floatingStopBtn.addEventListener('click', stopMonitoring);
            floatingCameraBtn.addEventListener('click', toggleCamera);
            floatingMicBtn.addEventListener('click', toggleMicrophone);
            
            // Theme toggle
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.code === 'Space' && isMonitoring) {
                    e.preventDefault();
                    toggleCamera();
                } else if (e.code === 'KeyM' && isMonitoring) {
                    e.preventDefault();
                    toggleMicrophone();
                } else if (e.code === 'KeyS' && !isMonitoring) {
                    e.preventDefault();
                    startMonitoring();
                } else if (e.code === 'Escape' && isMonitoring) {
                    e.preventDefault();
                    stopMonitoring();
                }
            });

            // PWA offline/online detection
            window.addEventListener('online', () => {
                showAlert('🌐 Connection restored! PWA sync enabled.', 'success');
            });

            window.addEventListener('offline', () => {
                showAlert('📱 Offline mode active - All monitoring features available!', 'warning');
            });
        }

        // Theme Management
        function setTheme(theme) {
            currentTheme = theme;
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                const icon = themeToggle.querySelector('svg');
                if (theme === 'dark') {
                    icon.innerHTML = '<circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>';
                } else {
                    icon.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>';
                }
            }
        }

        function toggleTheme() {
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            setTheme(newTheme);
        }

        // WebRTC Monitoring with Audio
        async function startMonitoring() {
            try {
                showAlert('📱 Requesting camera and microphone access...', 'success');
                
                // Request both camera and microphone
                videoStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'user'
                    },
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });

                // Get tracks
                videoTrack = videoStream.getVideoTracks()[0];
                audioTrack = videoStream.getAudioTracks();

                // Setup video feed
                videoFeed.srcObject = videoStream;
                videoFeed.style.display = 'block';
                videoPlaceholder.style.display = 'none';
                document.querySelector('.video-overlay').style.display = 'block';
                document.querySelector('.audio-level').style.display = 'flex';

                // Setup audio analysis
                setupAudioAnalysis();

                // Update UI
                isMonitoring = true;
                isCameraOn = true;
                isMicOn = true;
                
                statusDot.classList.remove('inactive');
                statusDot.classList.add('active');
                statusText.textContent = 'Live Monitoring Active';
                
                // Update main buttons
                startBtn.style.display = 'none';
                stopBtn.style.display = 'flex';
                
                // Update floating buttons
                floatingStartBtn.style.display = 'none';
                floatingStopBtn.style.display = 'flex';
                floatingCameraBtn.disabled = false;
                floatingMicBtn.disabled = false;
                
                processingStatus.textContent = 'AI processing active - Real-time eye & voice analysis in progress';

                // Start session timer
                sessionStartTime = Date.now();
                sessionTimer = setInterval(updateSessionTimer, 1000);

                // Start AI processing simulation
                startAIProcessing();

                showAlert('🎉 PWA Monitoring started! Use floating controls to toggle camera/mic', 'success');

            } catch (error) {
                console.error('Error accessing camera/microphone:', error);
                showAlert('❌ Camera or microphone access denied. Please allow permissions to start monitoring.', 'error');
                processingStatus.textContent = 'Camera & microphone access required for monitoring';
            }
        }

        function toggleCamera() {
            if (!videoTrack || !isMonitoring) return;

            isCameraOn = !isCameraOn;
            videoTrack.enabled = isCameraOn;

            if (isCameraOn) {
                floatingCameraBtn.classList.remove('camera-off');
                floatingCameraBtn.title = 'Turn Camera Off';
                console.log('📹 Camera turned ON');
            } else {
                floatingCameraBtn.classList.add('camera-off');
                floatingCameraBtn.title = 'Turn Camera On';
                console.log('📹 Camera turned OFF');
            }
        }

        function toggleMicrophone() {
            if (!audioTrack || !isMonitoring) return;

            isMicOn = !isMicOn;
            audioTrack.enabled = isMicOn;

            if (isMicOn) {
                floatingMicBtn.classList.remove('mic-off');
                floatingMicBtn.title = 'Turn Microphone Off';
                console.log('🎤 Microphone turned ON');
            } else {
                floatingMicBtn.classList.add('mic-off');
                floatingMicBtn.title = 'Turn Microphone On';
                console.log('🎤 Microphone turned OFF');
            }
        }

        function setupAudioAnalysis() {
            try {
                // Create audio context
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                audioAnalyser = audioContext.createAnalyser();
                audioSource = audioContext.createMediaStreamSource(videoStream);
                
                audioAnalyser.fftSize = 256;
                audioSource.connect(audioAnalyser);
                
                // Start audio level monitoring
                monitorAudioLevel();
                
            } catch (error) {
                console.error('Error setting up audio analysis:', error);
            }
        }

        function monitorAudioLevel() {
            if (!isMonitoring || !audioAnalyser) return;

            const bufferLength = audioAnalyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            
            function updateAudioLevel() {
                if (!isMonitoring) return;
                
                audioAnalyser.getByteFrequencyData(dataArray);
                
                // Calculate average audio level
                let sum = 0;
                for (let i = 0; i < bufferLength; i++) {
                    sum += dataArray[i];
                }
                const average = sum / bufferLength;
                audioLevel = Math.round(average);
                
                // Update UI
                document.getElementById('audioLevel').textContent = audioLevel;
                
                // Update audio bars visualization
                updateAudioBars(average);
                
                // Analyze voice stress (simplified simulation)
                analyzeVoiceStress(dataArray);
                
                requestAnimationFrame(updateAudioLevel);
            }
            
            updateAudioLevel();
        }

        function updateAudioBars(level) {
            const audioBars = document.querySelectorAll('.audio-bar');
            const normalizedLevel = level / 128; // Normalize to 0-1
            
            audioBars.forEach((bar, index) => {
                const threshold = (index + 1) * 0.2; // 0.2, 0.4, 0.6, 0.8, 1.0
                
                if (normalizedLevel > threshold) {
                    bar.classList.add('active');
                } else {
                    bar.classList.remove('active');
                }
            });
        }

        function analyzeVoiceStress(frequencyData) {
            // Simplified voice stress analysis
            let highFreqEnergy = 0;
            let midFreqEnergy = 0;
            
            for (let i = 0; i < frequencyData.length; i++) {
                if (i > frequencyData.length * 0.7) {
                    highFreqEnergy += frequencyData[i];
                } else if (i > frequencyData.length * 0.3) {
                    midFreqEnergy += frequencyData[i];
                }
            }
            
            // Calculate stress indicator
            const stressRatio = highFreqEnergy / (midFreqEnergy + 1);
            voiceStress = Math.min(Math.max(Math.round(stressRatio * 10), 0), 100);
            
            // Update UI periodically
            if (Math.random() < 0.1) {
                document.getElementById('voiceStressValue').textContent = voiceStress;
            }
        }

        function stopMonitoring() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
                videoTrack = null;
                audioTrack = null;
            }

            if (audioContext) {
                audioContext.close();
                audioContext = null;
                audioAnalyser = null;
                audioSource = null;
            }

            // Reset video display
            videoFeed.style.display = 'none';
            videoPlaceholder.style.display = 'flex';
            document.querySelector('.video-overlay').style.display = 'none';
            document.querySelector('.audio-level').style.display = 'none';

            // Update UI
            isMonitoring = false;
            statusDot.classList.remove('active');
            statusDot.classList.add('inactive');
            statusText.textContent = 'Monitoring Stopped';
            
            // Update main buttons
            startBtn.style.display = 'flex';
            stopBtn.style.display = 'none';
            
            // Update floating buttons
            floatingStartBtn.style.display = 'flex';
            floatingStopBtn.style.display = 'none';
            floatingCameraBtn.disabled = true;
            floatingMicBtn.disabled = true;
            floatingCameraBtn.classList.remove('camera-off');
            floatingMicBtn.classList.remove('mic-off');
            
            processingStatus.textContent = 'Click Start Monitor to begin analysis';

            // Clear session timer
            if (sessionTimer) {
                clearInterval(sessionTimer);
                sessionTimer = null;
            }

            // Reset values
            document.getElementById('leftEyeStatus').textContent = '--';
            document.getElementById('rightEyeStatus').textContent = '--';
            document.getElementById('audioLevel').textContent = '0';

            showAlert('⏹️ Monitoring stopped', 'warning');
        }

        function startAIProcessing() {
            if (!isMonitoring) return;

            // Simulate AI processing with realistic eye detection
            setInterval(() => {
                if (!isMonitoring) return;

                // Simulate eye detection
                const leftEyeOpen = Math.random() > 0.1;
                const rightEyeOpen = Math.random() > 0.1;

                // Update eye status
                document.getElementById('leftEyeStatus').textContent = leftEyeOpen ? 'Open' : 'Closed';
                document.getElementById('rightEyeStatus').textContent = rightEyeOpen ? 'Open' : 'Closed';

                // Update labels
                document.getElementById('leftEyeStatusLabel').textContent = leftEyeOpen ? 'Normal' : 'Blinking';
                document.getElementById('rightEyeStatusLabel').textContent = rightEyeOpen ? 'Normal' : 'Blinking';

                // Simulate blink detection
                if (!leftEyeOpen || !rightEyeOpen) {
                    const currentTime = Date.now();
                    if (currentTime - lastBlinkTime > 300) {
                        blinkCount++;
                        lastBlinkTime = currentTime;
                        document.getElementById('blinkCount').textContent = blinkCount;
                    }
                }

                // Trigger alerts based on conditions
                checkAlertConditions();

            }, 100);

            // Calculate metrics every 10 seconds
            setInterval(() => {
                if (!isMonitoring) return;
                
                const timeElapsed = (Date.now() - sessionStartTime) / 1000 / 60;
                blinkRate = timeElapsed > 0 ? Math.round(blinkCount / timeElapsed) : 0;
                
                if (blinkRate < 10) blinkRate = 15 + Math.floor(Math.random() * 5);
                if (blinkRate > 30) blinkRate = 20 + Math.floor(Math.random() * 5);
                
                document.getElementById('blinkRateValue').textContent = blinkRate;
                
                // Update health score based on multiple factors
                const eyeHealthScore = Math.max(60, 100 - (blinkRate < 15 ? 20 : 0));
                const voiceHealthScore = Math.max(60, 100 - voiceStress);
                const sessionHealthScore = Math.max(60, 100 - (timeElapsed * 1.5));
                
                healthScore = Math.round((eyeHealthScore + voiceHealthScore + sessionHealthScore) / 3);
                document.getElementById('healthScoreValue').textContent = healthScore;
                
            }, 10000);
        }

        function checkAlertConditions() {
            if (!isMonitoring) return;

            // Check for low blink rate
            if (blinkRate > 0 && blinkRate < 12) {
                showAlert('⚠️ Low blink rate detected! Try to blink more frequently.', 'warning');
            }

            // Check for high voice stress
            if (voiceStress > 60) {
                showAlert('🔊 Elevated voice stress detected! Consider taking a break.', 'warning');
            }

            // Check for loud audio environment
            if (audioLevel > 80) {
                showAlert('🔊 High noise environment detected. Consider using headphones.', 'warning');
            }

            // Check session length
            const sessionMinutes = (Date.now() - sessionStartTime) / 1000 / 60;
            if (sessionMinutes > 50 && sessionMinutes % 10 < 0.1) {
                showAlert('⏰ Extended session detected - consider taking a break!', 'warning');
            }
        }

        function updateSessionTimer() {
            if (!sessionStartTime) return;
            
            const elapsed = Date.now() - sessionStartTime;
            const hours = Math.floor(elapsed / (1000 * 60 * 60));
            const minutes = Math.floor((elapsed % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((elapsed % (1000 * 60)) / 1000);
            
            const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            sessionTimerEl.textContent = timeString;
            document.getElementById('sessionTimeValue').textContent = minutes;
        }

        function startMetricUpdates() {
            setInterval(() => {
                const blinkRateEl = document.getElementById('blinkRateValue');
                const currentBlink = parseInt(blinkRateEl.textContent);
                if (currentBlink > 0) {
                    const variation = Math.floor(Math.random() * 3) - 1;
                    const newBlink = Math.max(12, Math.min(25, currentBlink + variation));
                    blinkRateEl.textContent = newBlink;
                }

                updateTrendIndicators();
                
            }, 15000);
        }

        function updateTrendIndicators() {
            const trends = document.querySelectorAll('.metric-trend');
            trends.forEach((trend, index) => {
                const classes = ['trend-up', 'trend-down', 'trend-stable'];
                const randomClass = classes[Math.floor(Math.random() * classes.length)];
                
                trend.classList.remove(...classes);
                trend.classList.add(randomClass);
                
                const texts = ['Improving', 'Declining', 'Stable'];
                const icons = [
                    '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23,6 13.5,15.5 8.5,10.5 1,18"/></svg>',
                    '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23,18 13.5,8.5 8.5,13.5 1,6"/></svg>',
                    '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23,12 17,6 11,12 5,6 1,12"/></svg>'
                ];
                
                const iconIndex = classes.indexOf(randomClass);
                trend.innerHTML = icons[iconIndex] + ' ' + texts[iconIndex];
            });
        }

        // Alert System
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            alert.innerHTML = `
                <div class="alert-header">
                    <div class="alert-title">
                        ${type === 'error' ? '⚠️ Alert' : type === 'warning' ? '🟡 Warning' : type === 'success' ? '✅ Success' : 'ℹ️ Info'}
                    </div>
                    <button class="alert-close">&times;</button>
                </div>
                <div class="alert-message">${message}</div>
            `;
            
            alert.querySelector('.alert-close').addEventListener('click', () => {
                alert.classList.remove('show');
                setTimeout(() => alert.remove(), 300);
            });
            
            alertContainer.appendChild(alert);
            setTimeout(() => alert.classList.add('show'), 100);
            
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.classList.remove('show');
                    setTimeout(() => alert.remove(), 300);
                }
            }, 5000);
        }

        // Scroll Effects
        function setupScrollEffects() {
            const header = document.getElementById('header');
            const scrollProgress = document.getElementById('scrollProgress');
            
            let ticking = false;

            function updateScrollEffects() {
                const scrollTop = window.pageYOffset;
                const docHeight = document.documentElement.scrollHeight - window.innerHeight;
                const scrollPercent = Math.min((scrollTop / docHeight) * 100, 100);

                if (scrollProgress) {
                    scrollProgress.style.width = scrollPercent + '%';
                }

                if (header) {
                    if (scrollTop > 100) {
                        header.classList.add('scrolled');
                    } else {
                        header.classList.remove('scrolled');
                    }
                }

                ticking = false;
            }

            function requestScrollUpdate() {
                if (!ticking) {
                    requestAnimationFrame(updateScrollEffects);
                    ticking = true;
                }
            }

            window.addEventListener('scroll', requestScrollUpdate, { passive: true });
            updateScrollEffects();
        }

        // Mobile Menu
        function setupMobileMenu() {
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const mobileMenu = document.getElementById('mobileMenu');

            if (mobileMenuBtn && mobileMenu) {
                mobileMenuBtn.addEventListener('click', function() {
                    mobileMenuBtn.classList.toggle('active');
                    mobileMenu.classList.toggle('active');
                    document.body.style.overflow = mobileMenu.classList.contains('active') ? 'hidden' : '';
                });

                mobileMenu.addEventListener('click', function(e) {
                    if (e.target.classList.contains('nav-item')) {
                        mobileMenuBtn.classList.remove('active');
                        mobileMenu.classList.remove('active');
                        document.body.style.overflow = '';
                    }
                });
            }
        }

        // Animations
        function setupAnimations() {
            const observerOptions = {
                threshold: 0.1,
                rootMargin: '0px 0px -50px 0px'
            };

            const observer = new IntersectionObserver(function(entries) {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('visible');
                    }
                });
            }, observerOptions);

            document.querySelectorAll('.fade-in').forEach(el => {
                observer.observe(el);
            });
        }

        // PWA-specific functions
        function checkPWAStatus() {
            const isPWA = window.matchMedia('(display-mode: standalone)').matches || 
                          window.navigator.standalone === true;
            
            if (isPWA) {
                console.log('📱 Running as PWA!');
                document.body.classList.add('pwa-mode');
                showAlert('📱 Lumina AI PWA active - Enhanced monitoring features enabled!', 'success');
            } else {
                console.log('🌐 Running as web app');
            }
            
            // Listen for online/offline changes
            window.addEventListener('online', () => {
                showAlert('🌐 Connection restored - Data sync enabled!', 'success');
            });
            
            window.addEventListener('offline', () => {
                showAlert('📱 Offline mode - All monitoring features still available!', 'warning');
            });
        }

        // Enhanced PWA Installation prompt
        function handlePWAInstallation() {
            let installPromptEvent = null;
            
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                installPromptEvent = e;
                showPWAInstallBanner();
            });
            
            function showPWAInstallBanner() {
                const banner = document.createElement('div');
                banner.className = 'pwa-install-banner';
                banner.innerHTML = `
                    <div class="install-content">
                        <div class="install-icon">📱</div>
                        <div class="install-text">
                            <strong>Install Lumina AI</strong>
                            <p>Get the full app experience with offline monitoring capabilities</p>
                        </div>
                        <div class="install-actions">
                            <button class="install-btn primary" onclick="installPWA()">Install</button>
                            <button class="install-btn secondary" onclick="dismissPWABanner()">Later</button>
                        </div>
                    </div>
                `;
                
                // Add banner styles
                banner.style.cssText = `
                    position: fixed;
                    bottom: -100px;
                    left: 1rem;
                    right: 1rem;
                    background: var(--bg-glass-strong);
                    backdrop-filter: blur(30px);
                    border: 1px solid var(--border-light);
                    border-radius: 16px;
                    padding: 1.5rem;
                    box-shadow: 0 8px 32px var(--shadow-strong);
                    z-index: 10000;
                    transition: all var(--transition-bounce);
                `;
                
                document.body.appendChild(banner);
                setTimeout(() => {
                    banner.style.bottom = '1rem';
                }, 100);
                
                // Auto-dismiss after 10 seconds
                setTimeout(() => {
                    dismissPWABanner();
                }, 10000);
            }
            
            window.installPWA = async function() {
                if (!installPromptEvent) return;
                
                const result = await installPromptEvent.prompt();
                console.log('PWA install result:', result.outcome);
                
                if (result.outcome === 'accepted') {
                    showAlert('🎉 Installing Lumina AI... You\'ll be able to access it from your home screen!', 'success');
                }
                
                installPromptEvent = null;
                dismissPWABanner();
            };
            
            window.dismissPWABanner = function() {
                const banner = document.querySelector('.pwa-install-banner');
                if (banner) {
                    banner.style.bottom = '-100px';
                    setTimeout(() => banner.remove(), 300);
                }
            };
        }

        // Enhanced session management with PWA storage
        class SessionManager {
            constructor() {
                this.sessions = this.loadSessions();
                this.currentSession = null;
            }
            
            loadSessions() {
                try {
                    return JSON.parse(localStorage.getItem('lumina_monitor_sessions') || '[]');
                } catch {
                    return [];
                }
            }
            
            saveSessions() {
                localStorage.setItem('lumina_monitor_sessions', JSON.stringify(this.sessions));
            }
            
            startSession() {
                this.currentSession = {
                    id: Date.now(),
                    startTime: new Date().toISOString(),
                    endTime: null,
                    blinkCount: 0,
                    avgBlinkRate: 0,
                    maxVoiceStress: 0,
                    avgAudioLevel: 0,
                    healthScore: 94,
                    alerts: [],
                    cameraToggled: 0,
                    micToggled: 0
                };
                
                console.log('📊 Session started:', this.currentSession.id);
            }
            
            updateSession(data) {
                if (!this.currentSession) return;
                
                Object.assign(this.currentSession, data);
            }
            
            endSession() {
                if (!this.currentSession) return;
                
                this.currentSession.endTime = new Date().toISOString();
                this.currentSession.duration = Date.now() - new Date(this.currentSession.startTime).getTime();
                
                this.sessions.push(this.currentSession);
                this.saveSessions();
                
                console.log('📊 Session ended:', this.currentSession.id);
                showAlert(`📊 Session saved! Duration: ${Math.round(this.currentSession.duration / 60000)} minutes`, 'success');
                
                this.currentSession = null;
            }
            
            getSessionStats() {
                const totalSessions = this.sessions.length;
                const totalDuration = this.sessions.reduce((sum, s) => sum + (s.duration || 0), 0);
                const avgDuration = totalSessions > 0 ? totalDuration / totalSessions : 0;
                
                return {
                    totalSessions,
                    totalDuration: Math.round(totalDuration / 60000), // minutes
                    avgDuration: Math.round(avgDuration / 60000), // minutes
                    lastSession: this.sessions[this.sessions.length - 1]
                };
            }
        }

        // Initialize session manager
        const sessionManager = new SessionManager();

        // Enhanced monitoring with session tracking
        function enhancedStartMonitoring() {
            startMonitoring().then(() => {
                sessionManager.startSession();
                handlePWAInstallation();
                
                // Update session periodically
                setInterval(() => {
                    if (isMonitoring && sessionManager.currentSession) {
                        sessionManager.updateSession({
                            blinkCount: blinkCount,
                            avgBlinkRate: blinkRate,
                            maxVoiceStress: Math.max(sessionManager.currentSession.maxVoiceStress || 0, voiceStress),
                            avgAudioLevel: audioLevel,
                            healthScore: healthScore
                        });
                    }
                }, 5000);
            });
        }

        function enhancedStopMonitoring() {
            stopMonitoring();
            if (sessionManager.currentSession) {
                sessionManager.endSession();
            }
        }

        // Enhanced alert system with session tracking
        function trackAlert(message, type) {
            if (sessionManager.currentSession) {
                sessionManager.currentSession.alerts.push({
                    time: new Date().toISOString(),
                    message: message,
                    type: type
                });
            }
        }

        // Override original alert function to include tracking
        const originalShowAlert = showAlert;
        showAlert = function(message, type) {
            originalShowAlert(message, type);
            trackAlert(message, type);
        };

        // Enhanced camera/mic toggle tracking
        const originalToggleCamera = toggleCamera;
        toggleCamera = function() {
            originalToggleCamera();
            if (sessionManager.currentSession) {
                sessionManager.currentSession.cameraToggled++;
            }
        };

        const originalToggleMicrophone = toggleMicrophone;
        toggleMicrophone = function() {
            originalToggleMicrophone();
            if (sessionManager.currentSession) {
                sessionManager.currentSession.micToggled++;
            }
        };

        // PWA Background sync simulation
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.ready.then(registration => {
                console.log('🔄 PWA Service Worker ready for background sync');
                
                // Simulate background sync
                if ('sync' in window.ServiceWorkerRegistration.prototype) {
                    registration.sync.register('session-sync').then(() => {
                        console.log('📤 Background sync registered');
                    }).catch(err => {
                        console.warn('📤 Background sync registration failed:', err);
                    });
                }
            });
        }

        // PWA notification support
        function requestNotificationPermission() {
            if ('Notification' in window && 'serviceWorker' in navigator) {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        console.log('🔔 Notification permission granted');
                        showAlert('🔔 Notifications enabled! You\'ll get eye health alerts.', 'success');
                    }
                });
            }
        }

        // Enhanced break reminder with notifications
        function scheduleBreakReminder() {
            if (!isMonitoring) return;
            
            const breakInterval = 20 * 60 * 1000; // 20 minutes
            
            setTimeout(() => {
                if (isMonitoring) {
                    showAlert('⏰ Time for a break! Look away from the screen for 20 seconds.', 'warning');
                    
                    // PWA notification
                    if ('Notification' in window && Notification.permission === 'granted') {
                        new Notification('Lumina AI - Break Time!', {
                            body: 'Time for a 20-second eye break. Look at something 20 feet away.',
                            icon: '/icons/icon-192x192.png',
                            badge: '/icons/icon-72x72.png',
                            tag: 'eye-break',
                            requireInteraction: true
                        });
                    }
                    
                    // Schedule next break
                    scheduleBreakReminder();
                }
            }, breakInterval);
        }

        // Advanced health analytics
        function generateHealthReport() {
            const stats = sessionManager.getSessionStats();
            const currentHealth = {
                blinkRate: blinkRate,
                voiceStress: voiceStress,
                healthScore: healthScore,
                sessionTime: sessionTimerEl.textContent
            };
            
            return {
                summary: `Health Score: ${currentHealth.healthScore}/100`,
                sessions: stats,
                current: currentHealth,
                recommendations: getHealthRecommendations(currentHealth)
            };
        }

        function getHealthRecommendations(health) {
            const recommendations = [];
            
            if (health.blinkRate < 15) {
                recommendations.push('💧 Increase blink rate - Try the 20-20-20 rule');
            }
            
            if (health.voiceStress > 40) {
                recommendations.push('🧘 Reduce voice stress - Take deep breaths');
            }
            
            if (health.healthScore < 80) {
                recommendations.push('⚠️ Take a longer break - Consider closing your eyes for 2 minutes');
            }
            
            return recommendations;
        }

        // Export session data (PWA feature)
        function exportSessionData() {
            const data = {
                sessions: sessionManager.sessions,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `lumina-ai-sessions-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showAlert('📥 Session data exported successfully!', 'success');
        }

        // Keyboard shortcuts help
        function showKeyboardShortcuts() {
            const shortcuts = `
                <div style="background: var(--bg-glass-strong); backdrop-filter: blur(30px); border-radius: 16px; padding: 2rem; max-width: 400px;">
                    <h3 style="margin-bottom: 1rem; color: var(--text-primary);">⌨️ Keyboard Shortcuts</h3>
                    <div style="display: grid; gap: 0.5rem; font-family: monospace; font-size: 0.9rem;">
                        <div><kbd>S</kbd> - Start monitoring</div>
                        <div><kbd>Esc</kbd> - Stop monitoring</div>
                        <div><kbd>Space</kbd> - Toggle camera</div>
                        <div><kbd>M</kbd> - Toggle microphone</div>
                        <div><kbd>T</kbd> - Toggle theme</div>
                        <div><kbd>H</kbd> - Show this help</div>
                    </div>
                    <button onclick="closeShortcutsModal()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer;">Close</button>
                </div>
            `;
            
            const modal = document.createElement('div');
            modal.id = 'shortcuts-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10001;
            `;
            modal.innerHTML = shortcuts;
            document.body.appendChild(modal);
        }

        function closeShortcutsModal() {
            const modal = document.getElementById('shortcuts-modal');
            if (modal) modal.remove();
        }

        // Enhanced keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Don't trigger if user is typing in input
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            
            switch(e.code) {
                case 'KeyS':
                    if (!isMonitoring) {
                        e.preventDefault();
                        enhancedStartMonitoring();
                    }
                    break;
                case 'Escape':
                    if (isMonitoring) {
                        e.preventDefault();
                        enhancedStopMonitoring();
                    }
                    break;
                case 'Space':
                    if (isMonitoring) {
                        e.preventDefault();
                        toggleCamera();
                    }
                    break;
                case 'KeyM':
                    if (isMonitoring) {
                        e.preventDefault();
                        toggleMicrophone();
                    }
                    break;
                case 'KeyT':
                    e.preventDefault();
                    toggleTheme();
                    break;
                case 'KeyH':
                    e.preventDefault();
                    showKeyboardShortcuts();
                    break;
                case 'KeyE':
                    if (e.ctrlKey) {
                        e.preventDefault();
                        exportSessionData();
                    }
                    break;
                case 'KeyN':
                    if (e.ctrlKey) {
                        e.preventDefault();
                        requestNotificationPermission();
                    }
                    break;
            }
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
            }
            if (audioContext) {
                audioContext.close();
            }
            if (sessionTimer) {
                clearInterval(sessionTimer);
            }
            if (sessionManager.currentSession) {
                sessionManager.endSession();
            }
        });

        // Enhanced error handling with PWA support
        window.addEventListener('error', function(e) {
            console.error('Monitor Error:', e.error);
            showAlert('⚠️ An error occurred. PWA will continue working offline if needed.', 'error');
            
            // Log error for PWA debugging
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.ready.then(registration => {
                    registration.active?.postMessage({
                        type: 'ERROR_LOG',
                        error: e.error?.message || 'Unknown error',
                        timestamp: new Date().toISOString()
                    });
                });
            }
        });

        // PWA visibility change handling
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                console.log('📱 PWA hidden - monitoring continues in background');
            } else {
                console.log('📱 PWA visible - resuming active monitoring');
                if (isMonitoring) {
                    showAlert('👁️ Welcome back! Monitoring resumed.', 'success');
                }
            }
        });

        // Initialize PWA features
        document.addEventListener('DOMContentLoaded', function() {
            // Check PWA status
            setTimeout(checkPWAStatus, 1000);
            
            // Request notification permission after 5 seconds
            setTimeout(() => {
                if (!isMonitoring) {
                    requestNotificationPermission();
                }
            }, 5000);
            
            // Show session stats on load
            const stats = sessionManager.getSessionStats();
            if (stats.totalSessions > 0) {
                console.log('📊 Previous sessions:', stats);
                showAlert(`📊 Welcome back! You've completed ${stats.totalSessions} monitoring sessions.`, 'success');
            }
        });

        // Override original functions with enhanced versions
        document.getElementById('startBtn').onclick = enhancedStartMonitoring;
        document.getElementById('stopBtn').onclick = enhancedStopMonitoring;
        document.getElementById('floatingStartBtn').onclick = enhancedStartMonitoring;
        document.getElementById('floatingStopBtn').onclick = enhancedStopMonitoring;

        // Add PWA-specific features to the page
        function addPWAFeatures() {
            // Add export button to recommendations
            const exportBtn = document.createElement('div');
            exportBtn.className = 'recommendation-item';
            exportBtn.style.cursor = 'pointer';
            exportBtn.onclick = exportSessionData;
            exportBtn.innerHTML = `
                <div class="recommendation-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7,10 12,15 17,10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                </div>
                <div class="recommendation-content">
                    <h4 class="recommendation-title">Export Session Data</h4>
                    <p class="recommendation-desc">Download your monitoring sessions data for personal records or sharing with healthcare providers. (Ctrl+E)</p>
                </div>
            `;
            
            document.getElementById('recommendationList').appendChild(exportBtn);
        }

        // Add PWA features after page load
        setTimeout(addPWAFeatures, 2000);

        console.log('🎥🎤📱 Lumina AI Monitor with COMPLETE PWA support ready!');
        console.log('🚀 PWA Features: Offline support, session tracking, notifications, data export');
        console.log('⌨️ Press H for keyboard shortcuts');
    </script>
</body>
</html>
